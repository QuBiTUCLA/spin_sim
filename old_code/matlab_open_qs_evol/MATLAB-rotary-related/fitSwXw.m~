function [] = fitSwXw() 

%close all
clear all

%%%%%load('1DExp-seq-RotaryEchoCompleteEvol-SwXw-vary-mw_freq-2012-01-09-181648Uno50cycles');
%load('1DExp-seq-RotaryEchoCompleteEvol-SwXw-vary-mw_freq-2012-01-10-124433Uno75cycles'); 
%%%%%load('1DExp-seq-RotaryEchoCompleteEvol-SwXw-vary-mw_freq-2012-01-13-023143Uno87cycles.mat') %1.75 oscillations expected
%load('1DExp-seq-RotaryEchoCompleteEvol-SwXw-vary-mw_freq-2012-01-12-103314Uno75cycles.mat')
%load('1DExp-seq-RotaryEchoCompleteEvol-SwXw-vary-mw_freq-2012-01-14-005305Uno-87cycles.mat')
%load('1DExp-seq-RotaryEchoCompleteEvol-SwXw-vary-mw_freq-2012-01-16-200910Uno120cycles.mat')
%load('1DExp-seq-RotaryEchoCompleteEvol-SwXw-vary-mw_freq-2012-01-18-012020Uno120cycles.mat')

name{1} = '1DExp-seq-RotaryEchoCompleteEvol-SwXw-vary-mw_freq-2012-01-11-201924Uno50cycles.mat';
name{2} ='1DExp-seq-RotaryEchoCompleteEvol-SwXw-vary-mw_freq-2012-01-17-202727Uno75cycles.mat';
name{3} ='1DExp-seq-RotaryEchoCompleteEvol-SwXw-vary-mw_freq-2012-01-17-163452Uno87cyclesincomplete.mat'%alternative
name{4} = '1DExp-seq-RotaryEchoCompleteEvol-SwXw-vary-mw_freq-2012-01-14-174935Uno117cycles.mat';
name{5} = '1DExp-seq-RotaryEchoCompleteEvol-SwXw-vary-mw_freq-2012-01-15-034143Uno-164cycles.mat';
%freq 6.56
%load('1DExp-seq-Rabi-SwXw-vary-mw_freq-2012-01-16-011901Uno-Rabi164cycles.mat')

a = 1e-6*[2, 3, 3.5, 4.5, 6.5];
b = 1e-6*[1, 2, 3,   4,   6];
c = 1e-6*[3, 4, 4,   5,   7]; 

pbest = {};

for aux = 1:1:5
    
    
    load(name{aux});

rabi = Scan.ExperimentData{1}{1};
lowref = Scan.ExperimentData{1}{2};
oneref = Scan.ExperimentData{1}{3};
zeroref = Scan.ExperimentData{1}{4};

w = Scan.vary_begin:((Scan.vary_end -Scan.vary_begin)/(Scan.vary_points-1)):Scan.vary_end;

%average then normalize
rabinorm = (rabi - oneref)./(zeroref - oneref); %rabi normalized

figure(13)
plot(w,rabinorm)

figure(12); 
%subplot(2,1,1)
plot(w,rabinorm)
hold on
%fit decaying sin
myfun = @(p, w) p(1) * cos(2*pi*p(2)*(p(3) - w)) + p(4) + p(5)*cos(2*pi*p(2)*(p(6) + (p(3) - w))) + p(7)*cos(2*pi*p(2)*(p(6) - (p(3) - w)));
%p(1) amp
%p(2) freq of osci
%p(3) reson freq
%p(4) offset
%p(5) amp
%p(6) hyperfine
%p(7) amp

pinit = [0.2, a(aux), 3.1569e9,mean(rabinorm), 0.2, 2.1e6, 0.2];
% bounds for fitting parameters 
LB = [0.1,   b(aux),      3.15e9,     0.1,  0.1, 1.9e6, 0.1];
UB = [0.4,    c(aux),       3.16e9,     0.7,  0.4, 2.4e6, 0.4];
[pbest{aux},delta_p]=easyfit(w, rabinorm, pinit, myfun, LB, UB);
hold off

sigsig{aux} = rabinorm;
freqw{aux} = w;

end

figure(98)
plot(w,rabinorm,'r.')

color = ['r', 'b', 'k', 'k', 'g'];
color2 = ['.', '.', 'm*', 'k*', 'g*'];
figure(99)
hold on
for kk=[2 4 5]
plot(freqw{kk},plotfc(pbest{kk},freqw{kk}),color(kk))
hold on
plot(freqw{kk},sigsig{kk},'.')
%plot(freqw{kk},plotfc(pbest{kk},freqw{kk}),color(kk))
end
hold off

end

function curve = plotfc(p,w)
 curve = p(1) * cos(2*pi*p(2)*(p(3) - w)) + p(4) + p(5)*cos(2*pi*p(2)*(p(6) + (p(3) - w))) + p(7)*cos(2*pi*p(2)*(p(6) - (p(3) - w)));

end
